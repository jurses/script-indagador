#!/usr/bin/env bash

IMAGE_EXT="jpg jpeg gif bmp tif png raw awr psd xcf webp"

if [ ! -z "$1" ]; then
	indagador_files_directory="$(pwd)/indagador_files.d"
	selected_files="$indagador_files_directory/selected_files"
	dir_img_evidences="$indagador_files_directory/img_evidences"
else
	selected_files="$1"
	dir_img_evidences="$(pwd)/img_evidences"
fi

mkdir -p "$dir_img_evidences"

if [ ! -f "informe.html" ]; then
	## Aquí iría la cabecera del html
	> informe.html
	##
else
	count=1
	while [ -f "informe_$count.html" ]; do
		count=$((count + 1))
	done
	> informe_$count.html
fi

while IFS= read -r file_path
do
	file=$(basename "$file_path")
	file_extension=${file#*.}
	file_extension_lower_case=$(echo $file_extension | awk '{print tolower($0)}')

	for img_file_type in $IMAGE_EXT; do
		if [ $img_file_type == $file_extension_lower_case ]; then
			cp "$file_path" $dir_img_evidences
			echo "<div> <img src=\"$dir_img_evidences/$file\"></img> </div>" >> informe.html
			break
		fi
	done

	while IFS= read -r line
	do
		echo "<li>$line</li>" >> informe.html
	done < <(exiftool "$file_path")

done < <(cat "$selected_files")


echo "<li>Hash: $(sha256sum "$1" | cut -f1 -d' ')</li>" >> informe.html
